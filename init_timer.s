* mtk_asm.s - マルチタスクカーネル アセンブリ言語ルーチン
*
* 役割: タイマー割り込みを初期化し、hard_clock をタスクスイッチのコールバックとして登録する。
* ----------------------------------------------------------------------
* 外部参照
* ----------------------------------------------------------------------
	.extern hard_clock		/* タイマー割り込み時に呼び出すルーチン (hard_clock) */

* ----------------------------------------------------------------------
* グローバル宣言
* ----------------------------------------------------------------------
	.global init_timer		/* C言語から呼び出される初期化関数 */
	.global hard_clock		/* hard_clockも外部から参照される（割り込みベクタ登録用） */

* ----------------------------------------------------------------------
* 定義（equdefs.incからの流用を想定）
* ----------------------------------------------------------------------
	.equ SYSCALL_NUM_SET_TIMER, 4	/* SET_TIMER システムコール番号 */
	.equ TIMER_PERIOD_0_1MS, 10000	/* 1秒 = 10,000 * 0.1ms */

.text
.even

*----------------------------------------------------------------------
* init_timer: タイマー割り込み開始ルーチン
* 役割: mon.s のシステムコールを利用し、hard_clockをタイマー割り込みに登録・起動する。
* 戻り値なし。
*----------------------------------------------------------------------
init_timer:
	* (1) レジスタの退避
	* システムコールで使用するD0, D1, D2を退避する。
	movem.l	%D0/%D1/%D2, -(%SP)	

	* (2) SET_TIMER システムコール引数の設定
	move.l	#SYSCALL_NUM_SET_TIMER, %D0	/* D0 = システムコール番号 4 (SET_TIMER) */
	
	move.w	#TIMER_PERIOD_0_1MS, %D1	/* D1 = タイムアウト時間 (1秒 = 10000) */
	
	move.l	#hard_clock, %D2			/* D2 = コールバックルーチンアドレス (hard_clock) */

	* (3) システムコール呼び出し
	trap	#0							/* システムコールを実行し、タイマーを起動 */

	* (4) レジスタの復帰
	movem.l	(%SP)+, %D0/%D1/%D2		/* 退避したレジスタを復帰 */

	rts								/* C言語の呼び出し元に復帰 */

* ----------------------------------------------------------------------
* 【注】 hard_clock, swtch, first_task, pv_handler などもこのファイルに実装する。
* ----------------------------------------------------------------------
